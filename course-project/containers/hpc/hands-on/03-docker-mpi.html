<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hands-on: Building the Docker Image for Our MPI Application :: Course Project</title>
    <link rel="canonical" href="https://feelpp.github.io/course-project/course-project/containers/hpc/hands-on/03-docker-mpi.html">
    <link rel="prev" href="02-apptainer.html">
    <link rel="next" href="03-cicd-githubactions.html">
    <meta name="generator" content="Antora 3.1.7">
    <link rel="stylesheet" href="../../../../_/css/site.css">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
<script>!function(l,p){if(l.protocol!==p&&l.host=="docs.antora.org"){l.protocol=p}else if(/\.gitlab\.io$/.test(l.host)){l.replace(p+"//docs.antora.org"+l.pathname.substr(l.pathname.indexOf("/",1))+l.search+l.hash)}}(location,"https:")</script>

<script src="../../../../_/js/vendor/tabs-block-extension.js"></script>
<script src="../../../../_/js/vendor/tabs-block-behavior.js"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true,
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },

  TeX: {
      Macros: {
      bold: ["{\\bf #1}",1],
      calTh: "{\\mathcal{T}_h}",
      card: ["{\\operatorname{card}(#1)}",1],
      card: ["{\\operatorname{card}(#1)}",1],
      Ck: ["{\\mathcal{C}^{#1}}",1],
      deformt: ["{\\mathbf{\\varepsilon(#1)}}",1],
      diam: "{\\operatorname{diam}}",
      dim: ["{\\operatorname{dim}(#1)}",1],
      disp: ["{\\mathbf{#1}}",1],
      domain: "{\\Omega}",
      ds: "",
      essinf: "{\\operatorname{ess}\\, \\operatorname{inf}}",
      F:"{\\mathcal{F}}",
      geo: "{\\mathrm{geo}}",
      Ich: ["{\\mathcal{I}^{#1}_{c,h}#2}",2],
      Id: "{\\mathcal{I}}",
      Ilag: ["{\\mathcal{I}^{\\mathrm{lag}}_{#1}}",1],
      jump: ["{[\\![ #1 ]\\!]}",1],
      n:"{\\mathbf{n}}",
      Ne: "{N_{\\mathrm{e}}}",
      Next: "{\\mathrm{n}}",
      nf: "{n_f}",
      ngeo: "{n_{\\mathrm{geo}}}",
      Nma: "{N_{\\mathrm{ma}}}",
      NN: "{\\mathbb N}",
      Nno: "{N_{\\mathrm{no}}}",
      Nso: "{N_{\\mathrm{so}}}",
      opdim: "{\\operatorname{dim}}",
      p: "{\\mathrm{p}}",
      P:"{\\mathcal{P}}",
      Pch: ["{P^{#1}_{c,h}}",1],
      Pcho: ["{P^{#1}_{c,h,0}}",1],
      Pk: ["{\\mathcal{P}^{#1}}",1],
      poly: ["{\\mathbb{#1}",1],
      poly: ["{\\mathbb{#1}}",1],
      prect: ["{\\left\\(#1\\right\\)}",1],
      q:"{\\mathbf{q}}",
      Qch: ["{Q^{#1}_{c,h}}",1],
      Qk: ["{\\mathcal{Q}^{#1}}",1],
      R: ["{\\mathbb{R}^{#1}}",1],
      RR: "{\\mathbb R}",
      set: ["{\\left\\{#1\\right\\}}",1],
      stresst: ["{\\mathbf{\\sigma(#1)}}",1],
      T:"{\\mathcal{T}}",
      tr: "{\\operatorname{tr}}",
      v:"{\\mathbf{v}}",
      vertiii: ["\\left\\vert\\kern-0.25ex\\left\\vert\\kern-0.25ex\\left\\vert #1 \\right\\vert\\kern-0.25ex\\right\\vert\\kern-0.25ex\\right\\vert",1]
  },
  extensions: ["mhchem.js"] 
  }
});
</script>
<!--<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"></script>-->
<!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script> -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS_CHTML'></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>-->

<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.js" integrity="sha384-jmxIlussZWB7qCuB+PgKG1uLjjxbVVIayPJwi6cG6Zb4YKq0JIw+OMnkkEC7kYCq" crossorigin="anonymous"></script>-->
<script>var uiRootPath = '../../../../_'</script>

  </head>
  <body class="article">
<header class="header">
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark navbar-template-project"
        style="border-top: 4px solid #9E9E9E">
        <div class="navbar-brand">
            <div class="navbar-item feelpp-logo">
                <a href="https://feelpp.github.io/course-project">Course Project</a>
            </div>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>

        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
               <!--<div class="navbar-item">
                    <a href="../../../../_/../cours-project/python/index.html">Documentation Reference</a>
                </div>-->
                <div class="navbar-item has-dropdown is-hoverable download-item">
                    <div class="navbar-item"><a href="../../../../_/../cours-project/_attachments/cours-project.zip"
                            class="download-btn">Download the Notebooks</a></div>
                </div>
                <div class="navbar-item">
                    <a class="navbar-brand" href="https://www.cemosis.fr">
                        <img class="cemosis-logo" src="../../../../_/img/cemosis-logo.svg" alt="Cemosis logo" />
                    </a>
                </div>
                <div class="navbar-item">
                    <a class="navbar-brand" href="https://www.unistra.fr">
                        <img class="cemosis-logo" src="../../../../_/img/logo-unistra.png" alt="Unistra logo" />
                    </a>
                </div>
            </div>
        </div>
    </nav>
</header><div class="body">
<a href="#" class="menu-expand-toggle"></a>
<div class="nav-container" data-component="course-project" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../../index.html">Course Project</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../index.html">Introduction to Containers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../docker/index.html">Docker</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../docker/docker-overview.html">Docker Overview</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../docker/docker-problems-solved.html">The Problem Docker Solves</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../docker/docker-architecture.html">Docker Architecture</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#docker/docker-hpc.adoc">Installing Docker</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../apptainer/index.html">Apptainer</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../apptainer/apptainer-install.html">Installing Apptainer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../apptainer/tutorial.html">Tutorial</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">Containers for HPC</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cicd.html">CI/CD for HPC</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../best-practices.html">Best practices</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Hands-on Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../docker/hands-on/index.html">Docker Hands-on</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../docker/hands-on/01-getting-started.html">Getting Started with Docker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../docker/hands-on/02-advanced-usage.html">Advanced Docker Usage</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#docker/hands-on/docker-githubaction.adoc">GitHub Actions with Docker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#docker/hands-on/docker-postgres-example.adoc">Setting Up PostgreSQL with Docker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#docker/hands-on/docker-compose.adoc">Docker Compose</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#docker/hands-on/docker-deploy.adoc">Deploy services</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="00-classroom.html">C3B Classroom Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-docker.html">Docker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-apptainer.html">Apptainer</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="03-docker-mpi.html">Docker and MPI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-cicd-githubactions.html">CI/CD with GitHub Actions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-docker-cicd-app.html">CI/CD Docker Job</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-apptainer-cicd-app.html">CI/CD Apptainer Job</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-deploy.html">Deploy with Apptainer</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Course Project</span>
    <span class="version"></span>
  </div>
  <ul class="components">
      <li class="component">
        <a class="title" href="../../../../feelpp-antora-ui/index.html">Antora Feel++ UI</a>
      </li>
      <li class="component is-current">
        <a class="title" href="../../../index.html">Course Project</a>
      </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
  <button class="nav-toggle"></button>
    <a href="../../../index.html" class="home-link"></a>
  <nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../index.html">Course Project</a></li>
    <li>Hands-on Tutorials</li>
    <li><a href="00-classroom.html">C3B Classroom Setup</a></li>
    <li><a href="03-docker-mpi.html">Docker and MPI</a></li>
  </ul>
</nav>

  
    <div class="edit-this-page"><a href="https://github.com/feelpp/course-project/edit/master/docs/modules/containers/pages/hpc/hands-on/03-docker-mpi.adoc">Edit this Page</a></div>
  
  <div class="page-downloads">
  <span class="label">Download as</span>
  <ul class="download-options">
    <li>
      <a onclick="print(this)" href="#" data-toggle="tooltip" data-placement="left" title="Print to PDF"
         class="pdf-download">
        <img class="pdf-file-icon icon" src="../../../../_/img/pdf.svg"/> .pdf
      </a>
    </li>
  </ul>
</div>
</div>

  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Hands-on: Building the Docker Image for Our MPI Application</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_the_dockerfile">1. The Dockerfile</a></li>
<li><a href="#_callout_explanations">2. Callout Explanations</a></li>
<li><a href="#_would_you_do_the_image_differently">3. Would You Do the Image Differently?</a></li>
<li><a href="#_conclusion_on_dockerfile_explanation">4. Conclusion on Dockerfile Explanation</a></li>
<li><a href="#_multi_stage_build_modification">5. Multi-Stage Build modification</a>
<ul class="sectlevel2">
<li><a href="#_hands_on_building_a_multi_stage_docker_image_for_an_mpi_application">5.1. Hands-on: Building a Multi-Stage Docker Image for an MPI Application</a></li>
<li><a href="#_multi_stage_dockerfile">5.2. Multi-Stage Dockerfile</a></li>
</ul>
</li>
<li><a href="#_conclusion_on_multi_stage_dockerfile">6. Conclusion on Multi-Stage Dockerfile</a></li>
<li><a href="#_upload_to_github_container_registry_ghcr">7. Upload to GitHub Container Registry (GHCR)</a></li>
<li><a href="#_references">8. References</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph lead">
<p>In this session, we will walk through the Dockerfile used to build the Docker image for our MPI application. Each step is explained using callouts to help you understand the purpose of the instructions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_dockerfile"><a class="anchor" href="#_the_dockerfile"></a>1. The Dockerfile</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below is the complete Dockerfile we will explain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-dockerfile hljs" data-lang="dockerfile">FROM ubuntu:24.04                              <i class="conum" data-value="1"></i><b>(1)</b>

RUN apt-get update &amp;&amp; export DEBIAN_FRONTEND=noninteractive \   <i class="conum" data-value="2"></i><b>(2)</b>
    &amp;&amp; apt-get -y install --no-install-recommends \              <i class="conum" data-value="3"></i><b>(3)</b>
       git cmake g++ ninja-build openmpi-bin libopenmpi-dev python3 python3-pip python3-dev \   <i class="conum" data-value="4"></i><b>(4)</b>
       libboost-test-dev libboost-serialization-dev \            <i class="conum" data-value="5"></i><b>(5)</b>
    &amp;&amp; apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*                <i class="conum" data-value="6"></i><b>(6)</b>

COPY . /workspaces/mpihelloworld              <i class="conum" data-value="7"></i><b>(7)</b>

WORKDIR /workspaces/mpihelloworld             <i class="conum" data-value="8"></i><b>(8)</b>

# ENV OMPI_MCA_btl_vader_single_copy_mechanism=none  <i class="conum" data-value="9"></i><b>(9)</b>
ENV OMPI_ALLOW_RUN_AS_ROOT=1                  <i class="conum" data-value="10"></i><b>(10)</b>
ENV OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1          <i class="conum" data-value="11"></i><b>(11)</b>

RUN cmake --preset default \                  <i class="conum" data-value="12"></i><b>(12)</b>
    &amp;&amp; cmake --build --preset default \        <i class="conum" data-value="13"></i><b>(13)</b>
    &amp;&amp; ctest --preset default \                <i class="conum" data-value="14"></i><b>(14)</b>
    &amp;&amp; cmake --build --preset default -t install \  <i class="conum" data-value="15"></i><b>(15)</b>
    &amp;&amp; rm -rf build                            <i class="conum" data-value="16"></i><b>(16)</b></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_callout_explanations"><a class="anchor" href="#_callout_explanations"></a>2. Callout Explanations</h2>
<div class="sectionbody">
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>Base Image:</strong>
The image starts from <code>ubuntu:24.04</code>, ensuring a modern Ubuntu environment with predictable behavior and up-to-date packages.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>Update &amp; Set Environment:</strong>
<code>apt-get update</code> refreshes the package lists.
<code>export DEBIAN_FRONTEND=noninteractive</code> prevents interactive prompts during package installation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>Install Dependencies (Part 1):</strong>
<code>apt-get -y install --no-install-recommends</code> installs packages non-interactively and avoids installing unnecessary packages. This keeps the image lean.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><strong>Install Essential Tools:</strong>
Installs Git, CMake, G++, and Ninja Build to compile the MPI application.
Also installs OpenMPI and its development libraries needed for MPI programming, along with Python3 and its development tools.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><strong>Install Boost Libraries:</strong>
Installs Boost.Test and Boost.Serialization libraries, which are used for testing and data serialization in our MPI application.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><strong>Clean Up:</strong>
<code>apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*</code> removes cached package files to reduce image size.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><strong>Copy Application Code:</strong>
Copies the entire repository into <code>/workspaces/mpihelloworld</code> in the container. This makes your MPI application code available in the image.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td><strong>Set Working Directory:</strong>
Sets <code>/workspaces/mpihelloworld</code> as the working directory. All subsequent commands run in this directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td><strong>Optional Environment Variable:</strong>
This commented line shows an optional setting for MPI, which can be uncommented if needed to adjust the behavior of the OpenMPI “vader” communication module.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td><strong>Allow Running as Root:</strong>
<code>ENV OMPI_ALLOW_RUN_AS_ROOT=1</code> permits running MPI applications as the root user. This is often necessary in containerized environments if you don&#8217;t have a dedicated user for MPI.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td><strong>Confirm Running as Root:</strong>
<code>ENV OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1</code> confirms the previous setting, ensuring that OpenMPI does not abort when running as root.</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td><strong>Configure the Project:</strong>
Runs CMake with the preset named <code>default</code> (as defined in your <code>CMakePresets.json</code>). This step configures the build system.</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td><strong>Build the Project:</strong>
Builds the project using the default preset. This compiles your MPI application.</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td><strong>Run Tests:</strong>
Executes the tests with CTest using the default preset. This step verifies that the build is correct and that your tests pass.</td>
</tr>
<tr>
<td><i class="conum" data-value="15"></i><b>15</b></td>
<td><strong>Install the Application:</strong>
Builds the install target using CMake. This step installs the application into the container.</td>
</tr>
<tr>
<td><i class="conum" data-value="16"></i><b>16</b></td>
<td><strong>Clean Build Directory:</strong>
Removes the build directory to reduce the final image size after the installation is complete.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_would_you_do_the_image_differently"><a class="anchor" href="#_would_you_do_the_image_differently"></a>3. Would You Do the Image Differently?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This Dockerfile is designed for a development and testing environment, focusing on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Installing only necessary packages to keep the image lean.</p>
</li>
<li>
<p>Using CMake presets to configure, build, test, and install the application.</p>
</li>
<li>
<p>Cleaning up after installation to minimize image size.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Depending on your use case, you might consider:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Multi-Stage Builds:</strong> To further reduce image size by separating build dependencies from runtime dependencies.</p>
</li>
<li>
<p><strong>Specific Version Pinning:</strong> Pin package versions for even more reproducibility.</p>
</li>
<li>
<p><strong>Enhanced Caching:</strong> Organize layers to take advantage of Docker&#8217;s caching (e.g., updating apt cache separately).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For an HPC application development environment, this image strikes a balance between simplicity and functionality.
In production, you may adopt a multi-stage build to isolate build and runtime environments.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_on_dockerfile_explanation"><a class="anchor" href="#_conclusion_on_dockerfile_explanation"></a>4. Conclusion on Dockerfile Explanation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This hands‑on guide explained each step of the Dockerfile used to build the Docker image for our MPI application.
By understanding each instruction and its purpose, you can adapt the Dockerfile to meet your specific needs in HPC development and testing.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_multi_stage_build_modification"><a class="anchor" href="#_multi_stage_build_modification"></a>5. Multi-Stage Build modification</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_hands_on_building_a_multi_stage_docker_image_for_an_mpi_application"><a class="anchor" href="#_hands_on_building_a_multi_stage_docker_image_for_an_mpi_application"></a>5.1. Hands-on: Building a Multi-Stage Docker Image for an MPI Application</h3>
<div class="paragraph">
<p>In this session, we will build a Docker image for our MPI application using a multi-stage Dockerfile. Multi-stage builds allow us to separate the build environment from the runtime environment, reducing the final image size and ensuring a clean runtime.</p>
</div>
<div class="sect3">
<h4 id="_step_1_understanding_the_multi_stage_dockerfile"><a class="anchor" href="#_step_1_understanding_the_multi_stage_dockerfile"></a>5.1.1. Step 1: Understanding the Multi-Stage Dockerfile</h4>
<div class="paragraph">
<p>The Dockerfile is divided into two stages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Builder Stage:</strong>
This stage (labeled <code>builder</code>) uses Ubuntu 24.04, installs all build dependencies, copies your source code, and then uses CMake presets to configure, compile, test, and install your MPI application.</p>
</li>
<li>
<p><strong>Runtime Stage:</strong>
This stage (labeled <code>runtime</code>) starts again from Ubuntu 24.04, but only installs the runtime dependencies necessary to execute your MPI application. It then copies the installed application from the builder stage.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_step_2_build_the_docker_image"><a class="anchor" href="#_step_2_build_the_docker_image"></a>5.1.2. Step 2: Build the Docker Image</h4>
<div class="paragraph">
<p>To build the Docker image, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">docker build -t myapp:latest .</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command executes the multi-stage build, producing a final runtime image tagged as <code>myapp:latest</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_3_run_the_mpi_application"><a class="anchor" href="#_step_3_run_the_mpi_application"></a>5.1.3. Step 3: Run the MPI Application</h4>
<div class="paragraph">
<p>Once built, you can run your MPI application from the Docker image. For example, to run the application interactively:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">docker run --rm -it myapp:latest /bin/bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Inside the container, you can execute your application, or rely on the default entrypoint which runs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mpirun -np 4 ./my_mpi_app</code></pre>
</div>
</div>
<div class="paragraph">
<p>This uses the built-in default command defined in the Dockerfile.</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_4_verify_and_test"><a class="anchor" href="#_step_4_verify_and_test"></a>5.1.4. Step 4: Verify and Test</h4>
<div class="paragraph">
<p>Ensure that the image works as expected by running your tests locally in the container. Use your CTest output to verify that the application behaves correctly.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_multi_stage_dockerfile"><a class="anchor" href="#_multi_stage_dockerfile"></a>5.2. Multi-Stage Dockerfile</h3>
<div class="paragraph">
<p>Below is the complete Dockerfile with callouts explaining each step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-dockerfile hljs" data-lang="dockerfile"># Stage 1: Build                                                 <i class="conum" data-value="1"></i><b>(1)</b>
FROM ubuntu:24.04 AS builder

# Update package lists and install build dependencies           <i class="conum" data-value="2"></i><b>(2)</b>
RUN apt-get update &amp;&amp; export DEBIAN_FRONTEND=noninteractive \
    &amp;&amp; apt-get -y install --no-install-recommends \
       git cmake g++ ninja-build openmpi-bin libopenmpi-dev \
       python3 python3-pip python3-dev \
       libboost-test-dev libboost-serialization-dev \
    &amp;&amp; apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*

# Copy the application source code into the builder stage         <i class="conum" data-value="3"></i><b>(3)</b>
COPY . /workspaces/mpihelloworld

# Set the working directory for the build                           <i class="conum" data-value="4"></i><b>(4)</b>
WORKDIR /workspaces/mpihelloworld

# Set environment variables to allow MPI to run as root             <i class="conum" data-value="5"></i><b>(5)</b>
ENV OMPI_ALLOW_RUN_AS_ROOT=1
ENV OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1

# Configure, build, test, and install the application using CMake presets <i class="conum" data-value="6"></i><b>(6)</b>
RUN cmake --preset default      \
    &amp;&amp; cmake --build --preset default                  \
    &amp;&amp; ctest --preset default                          \
    &amp;&amp; cmake --build --preset default -t install        \
    &amp;&amp; rm -rf build

# Stage 2: Runtime                                                 <i class="conum" data-value="7"></i><b>(7)</b>
FROM ubuntu:24.04 AS runtime

# Install runtime dependencies (only what is needed to run the application) <i class="conum" data-value="8"></i><b>(8)</b>
RUN apt-get update &amp;&amp; export DEBIAN_FRONTEND=noninteractive \
    &amp;&amp; apt-get -y install --no-install-recommends           \
       openmpi-bin libopenmpi3t64                           \
       libboost-test1.83.0 libboost-serialization1.83.0     \
       python3 python3-pip python3-dev                      \
    &amp;&amp; apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/*

# Copy the installed application from the builder stage             <i class="conum" data-value="9"></i><b>(9)</b>
COPY --from=builder /usr/local /usr/local

# Optionally, copy additional runtime files if needed                 <i class="conum" data-value="10"></i><b>(10)</b>
# COPY --from=builder /workspaces/mpihelloworld/config /config

# Set the working directory (if needed)                              <i class="conum" data-value="11"></i><b>(11)</b>
WORKDIR /workspaces/mpihelloworld

# Set the runtime environment variables for MPI                       <i class="conum" data-value="12"></i><b>(12)</b>
ENV OMPI_ALLOW_RUN_AS_ROOT=1
ENV OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><strong>Build Stage:</strong> Uses Ubuntu 24.04 as the base image for building the application.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><strong>Install Build Dependencies:</strong> Updates package lists and installs tools such as Git, CMake, G++, Ninja, OpenMPI, Python3, and Boost libraries necessary for compiling and testing the MPI application. The <code>--no-install-recommends</code> flag ensures that only essential packages are installed, keeping the image lean.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>Copy Source Code:</strong> Copies your entire project into the builder stage.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><strong>Set Working Directory:</strong> Sets <code>/workspaces/mpihelloworld</code> as the directory for subsequent build commands.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><strong>MPI Environment Variables:</strong> Sets environment variables to allow MPI to run as root, which is common in containerized environments.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><strong>Build, Test, and Install:</strong> Uses CMake presets to configure the build, compile the code, run tests with CTest, and install the application. Finally, it removes the build directory to reduce image size.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><strong>Runtime Stage:</strong> Starts a new stage from Ubuntu 24.04 that contains only the runtime dependencies.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td><strong>Install Runtime Dependencies:</strong> Installs only the packages needed to run the MPI application (e.g., OpenMPI runtime libraries, minimal Boost libraries, and Python3).</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td><strong>Copy Installed Application:</strong> Copies the installed application (assumed to be located in <code>/usr/local</code>) from the builder stage to the runtime stage.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td><strong>Optional Files:</strong> You can copy additional runtime configuration files if needed.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td><strong>Set Runtime Working Directory:</strong> Sets the working directory for the runtime environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td><strong>Runtime MPI Variables:</strong> Re-establishes the environment variables for MPI to run as root
---</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_on_multi_stage_dockerfile"><a class="anchor" href="#_conclusion_on_multi_stage_dockerfile"></a>6. Conclusion on Multi-Stage Dockerfile</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This hands‑on session has demonstrated how to create a multi‑stage Dockerfile that builds, tests, and packages an MPI application efficiently.
Multi-stage builds help isolate build and runtime environments, reduce final image size, and simplify dependency management.</p>
</div>
<div class="paragraph">
<p>Questions? Let&#8217;s discuss how you might further optimize or customize this Dockerfile for your HPC applications!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_upload_to_github_container_registry_ghcr"><a class="anchor" href="#_upload_to_github_container_registry_ghcr"></a>7. Upload to GitHub Container Registry (GHCR)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To upload the Docker image to GitHub Container Registry (GHCR), you need to log in to GHCR and push the image and follow the steps
<a href="01-docker.html" class="xref page">&gt; here</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references"><a class="anchor" href="#_references"></a>8. References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Docker Documentation: <a href="https://docs.docker.com/" class="bare">docs.docker.com/</a></p>
</li>
<li>
<p>Dockerfile reference: <a href="https://docs.docker.com/reference/dockerfile/" class="bare">docs.docker.com/reference/dockerfile/</a></p>
</li>
<li>
<p>Building best practices: <a href="https://docs.docker.com/build/building/best-practices/" class="bare">docs.docker.com/build/building/best-practices/</a></p>
</li>
</ul>
</div>
<div class="paragraph center">
<p>Questions? Let&#8217;s discuss how to further optimize this Dockerfile for your projects!</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-apptainer.html">Apptainer</a></span>
  <span class="next"><a href="03-cicd-githubactions.html">CI/CD with GitHub Actions</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer"
    style="border-top: 2px solid #e9e9e9; background-color: #fafafa; padding-bottom: 2em; padding-top: 2em;">
    <div class="container" style="display: flex; flex-direction: column; align-items: center; gap: 0.5em;">
        <div>
            <a href="https://www.cemosis.fr">
                <img src="../../../../_/img/cemosis-logo.svg" alt="Cemosis logo" height="50">
            </a>
            &nbsp;&nbsp;&nbsp;&nbsp;
            <a href="https://www.unistra.fr">
                <img src="../../../../_/img/logo-unistra.png" alt="Unistra logo" height="50">
            </a>
        </div>
        <span style="font-size: 0.8rem; color: #9e9e9e">© 2025 <a href="https://www.cemosis.fr"
                style="text-decoration: underline;">Cemosis</a>, Université de Strasbourg</span>
    </div>
</footer><script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>


<script async src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../../../_/js/vendor/fontawesome.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>


<script type="text/javascript">
function toggleFullScreen() {
   var doc = window.document;
   var docEl = doc.documentElement;

   var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
   var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

   if(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
       requestFullScreen.call(docEl);
   }
   else {
       cancelFullScreen.call(doc);
   }
}
</script>
  </body>
</html>
