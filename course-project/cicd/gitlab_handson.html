<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hands on: Gitlab CI/CD :: Course Project</title>
    <link rel="canonical" href="https://feelpp.github.io/course-project/course-project/cicd/gitlab_handson.html">
    <meta name="generator" content="Antora 3.1.7">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<script>!function(l,p){if(l.protocol!==p&&l.host=="docs.antora.org"){l.protocol=p}else if(/\.gitlab\.io$/.test(l.host)){l.replace(p+"//docs.antora.org"+l.pathname.substr(l.pathname.indexOf("/",1))+l.search+l.hash)}}(location,"https:")</script>

<script src="../../_/js/vendor/tabs-block-extension.js"></script>
<script src="../../_/js/vendor/tabs-block-behavior.js"></script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true,
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },

  TeX: {
      Macros: {
      bold: ["{\\bf #1}",1],
      calTh: "{\\mathcal{T}_h}",
      card: ["{\\operatorname{card}(#1)}",1],
      card: ["{\\operatorname{card}(#1)}",1],
      Ck: ["{\\mathcal{C}^{#1}}",1],
      deformt: ["{\\mathbf{\\varepsilon(#1)}}",1],
      diam: "{\\operatorname{diam}}",
      dim: ["{\\operatorname{dim}(#1)}",1],
      disp: ["{\\mathbf{#1}}",1],
      domain: "{\\Omega}",
      ds: "",
      essinf: "{\\operatorname{ess}\\, \\operatorname{inf}}",
      F:"{\\mathcal{F}}",
      geo: "{\\mathrm{geo}}",
      Ich: ["{\\mathcal{I}^{#1}_{c,h}#2}",2],
      Id: "{\\mathcal{I}}",
      Ilag: ["{\\mathcal{I}^{\\mathrm{lag}}_{#1}}",1],
      jump: ["{[\\![ #1 ]\\!]}",1],
      n:"{\\mathbf{n}}",
      Ne: "{N_{\\mathrm{e}}}",
      Next: "{\\mathrm{n}}",
      nf: "{n_f}",
      ngeo: "{n_{\\mathrm{geo}}}",
      Nma: "{N_{\\mathrm{ma}}}",
      NN: "{\\mathbb N}",
      Nno: "{N_{\\mathrm{no}}}",
      Nso: "{N_{\\mathrm{so}}}",
      opdim: "{\\operatorname{dim}}",
      p: "{\\mathrm{p}}",
      P:"{\\mathcal{P}}",
      Pch: ["{P^{#1}_{c,h}}",1],
      Pcho: ["{P^{#1}_{c,h,0}}",1],
      Pk: ["{\\mathcal{P}^{#1}}",1],
      poly: ["{\\mathbb{#1}",1],
      poly: ["{\\mathbb{#1}}",1],
      prect: ["{\\left\\(#1\\right\\)}",1],
      q:"{\\mathbf{q}}",
      Qch: ["{Q^{#1}_{c,h}}",1],
      Qk: ["{\\mathcal{Q}^{#1}}",1],
      R: ["{\\mathbb{R}^{#1}}",1],
      RR: "{\\mathbb R}",
      set: ["{\\left\\{#1\\right\\}}",1],
      stresst: ["{\\mathbf{\\sigma(#1)}}",1],
      T:"{\\mathcal{T}}",
      tr: "{\\operatorname{tr}}",
      v:"{\\mathbf{v}}",
      vertiii: ["\\left\\vert\\kern-0.25ex\\left\\vert\\kern-0.25ex\\left\\vert #1 \\right\\vert\\kern-0.25ex\\right\\vert\\kern-0.25ex\\right\\vert",1]
  },
  extensions: ["mhchem.js"] 
  }
});
</script>
<!--<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"></script>-->
<!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script> -->
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS_CHTML'></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>-->

<!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css" integrity="sha384-TEMocfGvRuD1rIAacqrknm5BQZ7W7uWitoih+jMNFXQIbNl16bO8OZmylH/Vi/Ei" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.js" integrity="sha384-jmxIlussZWB7qCuB+PgKG1uLjjxbVVIayPJwi6cG6Zb4YKq0JIw+OMnkkEC7kYCq" crossorigin="anonymous"></script>-->
<script>var uiRootPath = '../../_'</script>

  </head>
  <body class="article">
<header class="header">
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark navbar-template-project"
        style="border-top: 4px solid #9E9E9E">
        <div class="navbar-brand">
            <div class="navbar-item feelpp-logo">
                <a href="https://feelpp.github.io/course-project">Course Project</a>
            </div>
            <button class="navbar-burger" data-target="topbar-nav">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>

        <div id="topbar-nav" class="navbar-menu">
            <div class="navbar-end">
               <!--<div class="navbar-item">
                    <a href="../../_/../cours-project/python/index.html">Documentation Reference</a>
                </div>-->
                <div class="navbar-item has-dropdown is-hoverable download-item">
                    <div class="navbar-item"><a href="../../_/../cours-project/_attachments/cours-project.zip"
                            class="download-btn">Download the Notebooks</a></div>
                </div>
                <div class="navbar-item">
                    <a class="navbar-brand" href="https://www.cemosis.fr">
                        <img class="cemosis-logo" src="../../_/img/cemosis-logo.svg" alt="Cemosis logo" />
                    </a>
                </div>
                <div class="navbar-item">
                    <a class="navbar-brand" href="https://www.unistra.fr">
                        <img class="cemosis-logo" src="../../_/img/logo-unistra.png" alt="Unistra logo" />
                    </a>
                </div>
            </div>
        </div>
    </nav>
</header><div class="body">
<a href="#" class="menu-expand-toggle"></a>
<div class="nav-container" data-component="course-project" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Course Project</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../containers/index.html">Introduction to Containers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../containers/docker/index.html">Docker</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../containers/docker/docker-overview.html">Docker Overview</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../containers/docker/docker-problems-solved.html">The Problem Docker Solves</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../containers/docker/docker-architecture.html">Docker Architecture</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#docker/docker-hpc.adoc">Installing Docker</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../containers/apptainer/index.html">Apptainer</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../containers/apptainer/apptainer-install.html">Installing Apptainer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../containers/apptainer/tutorial.html">Tutorial</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../containers/hpc/index.html">Containers for HPC</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../containers/hpc/cicd.html">CI/CD for HPC</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../containers/hpc/best-practices.html">Best practices</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../containers/hpc/advanced.html">Advanced Topics</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Hands-on Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../containers/docker/hands-on/index.html">Docker Hands-on</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../containers/docker/hands-on/01-getting-started.html">Getting Started with Docker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../containers/docker/hands-on/02-advanced-usage.html">Advanced Docker Usage</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#docker/hands-on/docker-githubaction.adoc">GitHub Actions with Docker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#docker/hands-on/docker-postgres-example.adoc">Setting Up PostgreSQL with Docker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#docker/hands-on/docker-compose.adoc">Docker Compose</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#docker/hands-on/docker-deploy.adoc">Deploy services</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../containers/hpc/hands-on/00-classroom.html">C3B Classroom Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../containers/hpc/hands-on/01-docker.html">Docker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../containers/hpc/hands-on/02-apptainer.html">Apptainer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../containers/hpc/hands-on/03-docker-mpi.html">Docker and MPI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../containers/hpc/hands-on/03-cicd-githubactions.html">CI/CD with GitHub Actions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../containers/hpc/hands-on/04-docker-cicd-app.html">CI/CD Docker Job</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../containers/hpc/hands-on/04-apptainer-cicd-app.html">CI/CD Apptainer Job</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../containers/hpc/hands-on/05-deploy.html">Deploy with Apptainer</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Course Project</span>
    <span class="version"></span>
  </div>
  <ul class="components">
      <li class="component">
        <a class="title" href="../../feelpp-antora-ui/index.html">Antora Feel++ UI</a>
      </li>
      <li class="component is-current">
        <a class="title" href="../index.html">Course Project</a>
      </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
  <button class="nav-toggle"></button>
    <a href="../index.html" class="home-link"></a>
  <nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Course Project</a></li>
    <li><a href="gitlab_handson.html">Hands on: Gitlab CI/CD</a></li>
  </ul>
</nav>

  
    <div class="edit-this-page"><a href="https://github.com/feelpp/course-project/edit/master/docs/modules/cicd/pages/gitlab_handson.adoc">Edit this Page</a></div>
  
  <div class="page-downloads">
  <span class="label">Download as</span>
  <ul class="download-options">
    <li>
      <a onclick="print(this)" href="#" data-toggle="tooltip" data-placement="left" title="Print to PDF"
         class="pdf-download">
        <img class="pdf-file-icon icon" src="../../_/img/pdf.svg"/> .pdf
      </a>
    </li>
  </ul>
</div>
</div>

  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Hands on: Gitlab CI/CD</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_exercise_1_connecting_with_karolina_runners">1. Exercise 1: Connecting with Karolina Runners</a>
<ul class="sectlevel2">
<li><a href="#_step_i_making_our_repository">1.1. Step I: Making our repository</a></li>
<li><a href="#_step_ii_adding_a_hello_world_ci_job">1.2. Step II: Adding a Hello World CI Job</a></li>
</ul>
</li>
<li><a href="#_exercise_2_converting_our_github_app">2. Exercise 2: Converting our Github App</a>
<ul class="sectlevel2">
<li><a href="#_step_1_getting_the_c_mpi_application">2.1. Step 1: Getting the C++ MPI Application</a></li>
<li><a href="#_step_2_converting_from_github_to_gitlab">2.2. Step 2: Converting from GitHub to GitLab</a></li>
<li><a href="#_step_3_deploying_through_jacamarci_to_slurm">2.3. Step 3: Deploying through JacamarCI to SLURM</a></li>
<li><a href="#_step_4_uploading_the_built_package_as_an_artifact">2.4. Step 4: Uploading the built package as an artifact</a></li>
</ul>
</li>
<li><a href="#_bonus_exercise_self_hosted_runners">3. (Bonus) Exercise: Self-hosted Runners</a>
<ul class="sectlevel2">
<li><a href="#_setting_up_your_personal_runner">3.1. Setting up your personal runner</a></li>
<li><a href="#_building_a_simple_pipeline">3.2. Building a simple pipeline</a></li>
</ul>
</li>
<li><a href="#_bonus_exercise_containers_through_gitlab">4. (Bonus) Exercise: Containers through GitLab</a>
<ul class="sectlevel2">
<li><a href="#_deploying_to_slurm">4.1. Deploying to SLURM</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_exercise_1_connecting_with_karolina_runners"><a class="anchor" href="#_exercise_1_connecting_with_karolina_runners"></a>1. Exercise 1: Connecting with Karolina Runners</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our first task is to start working the officially provided Gitlab Runners from Karolina.</p>
</div>
<div class="paragraph">
<p>As mentioned before, we have a number of runners available, however, we cannot choose one particular one to run our CI job. Instead, we can "match" with one runner, out of a possible group of runners, using the CI job labels, or tags.</p>
</div>
<div class="sect2">
<h3 id="_step_i_making_our_repository"><a class="anchor" href="#_step_i_making_our_repository"></a>1.1. Step I: Making our repository</h3>
<div class="paragraph">
<p>First, we have to create a repository on the offical IT4I Gitlab.</p>
</div>
<div class="paragraph">
<p><a href="https://code.it4i.cz">Gitlab from IT4I</a></p>
</div>
<div class="paragraph">
<p>If you have access to the training resources, you also must have an
account on the IT4I Gitlab.</p>
</div>
<div class="paragraph">
<p>Create a repository called repo_one.
(you can name it anything you like, but we will refer it as repo_one.)</p>
</div>
<div class="paragraph">
<p>After creating the repo, navigate to Settings &#8594; CI/CD.</p>
</div>
<div class="paragraph">
<p>Here, you can see a list of available runners. Take careful note of
the tags that each runner equips.</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_ii_adding_a_hello_world_ci_job"><a class="anchor" href="#_step_ii_adding_a_hello_world_ci_job"></a>1.2. Step II: Adding a Hello World CI Job</h3>
<div class="paragraph">
<p>Now, we will add our first Gitlab CI job, by adding the Gitlab YAML
workflow file  to the repositoy.</p>
</div>
<div class="paragraph">
<p>To do this, we can either edit the repository directly in the browser,
or you can clone the repository to your local system and edit it in
your preffered IDE/Environment.</p>
</div>
<div class="paragraph">
<p>Create an empty file, and name it .gitlab-ci.yml
(take care of any typos).</p>
</div>
<div class="paragraph">
<p>Now, add the following basic YAML to it.</p>
</div>
<div class="listingblock">
<div class="title">.gitlab-ci.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">hello-runner-docker:
  image: alpine
  tags:
    - docker
    - centos7
  script:
    - echo 'HELLO WORLD!'
    - hostname</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, we are trying to target on of the 5 runners that have the Docker executor.
These runners are on a separate cloud cluster from IT4I, so we won&#8217;t be using the Karolina or Barbara runners just yet, for out first Hello World application.</p>
</div>
<div class="paragraph">
<p>Now, commit and push the file.</p>
</div>
<div class="paragraph">
<p>Go to your repository &#8594; Build &#8594; Jobs.</p>
</div>
<div class="paragraph">
<p>Hopefully, you should see a succesful job run, and a Hello World printed out!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exercise_2_converting_our_github_app"><a class="anchor" href="#_exercise_2_converting_our_github_app"></a>2. Exercise 2: Converting our Github App</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_step_1_getting_the_c_mpi_application"><a class="anchor" href="#_step_1_getting_the_c_mpi_application"></a>2.1. Step 1: Getting the C++ MPI Application</h3>
<div class="paragraph">
<p>Now, let&#8217;s move on, or go back rather, to the MPI application from Day 1.</p>
</div>
<div class="paragraph">
<p>We could do this using the same repository as Day 1, e.g. by mirroring
the repo, however, to keep it clean and separate to GitLab, we will
make a new repo on code.it4i.cz, and add the required files there manually.</p>
</div>
<div class="paragraph">
<p>First, we create a new repo, let&#8217;s call it repo_two.</p>
</div>
<div class="paragraph">
<p>Then, to get the required files, we can first clone the Day 1 Github repository.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">git clone https://github.com/coe-hidalgo2/202503-c3b-shirgho.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s move the initially required files and folders to our new repo.(repo_two)</p>
</div>
<div class="listingblock">
<div class="content">
<pre>myapp/
test/
README.adoc
LICENSE
CMakePresets.json
CMakeLists.txt</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_converting_from_github_to_gitlab"><a class="anchor" href="#_step_2_converting_from_github_to_gitlab"></a>2.2. Step 2: Converting from GitHub to GitLab</h3>
<div class="paragraph">
<p>Now, comes our first challange. We have our first pipeline from
Christoph, that compiled and ran our c++ application. But how do we
run this on our Gitlab Runners?</p>
</div>
<div class="paragraph">
<p>Here is the ci.yml code from this point in the Github Actions training:</p>
</div>
<div class="listingblock">
<div class="title">ci.yml (Github Actions YAML)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: CI - Configure, Build, Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-test:
    runs-on: self-ubuntu-24.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure the Build System
        run: |
          cmake --preset default

      - name: Build the Project
        run: |
          cmake --build --preset default

      - name: Run Tests
        run: |
          ctest --preset default</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Hints</div>
<div class="content">
<pre>1. We need to replace the triggers in "on" with rules.
2. We don't need the workflow dispatch.
3. We don't need the "jobs" keyword.
4. We need to define a "stage", a name for our stage and a name for our "job".
5. We need to use the correct IT4I runner labels instead of runs on.
6. We can replace the checkout action with a GitLab variable.
7. We replace the "run" keyword for the bash commands with "script".</pre>
</div>
</div>
<details class="proof">
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">build-and-test:
  tags:
    - it4i
    - karolina
    - slurmjob

  rules:
    - if: $CI_COMMIT_BRANCH == 'main'
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

  variables:
    GIT_CHECKOUT: "true"

  script:
    - module load Boost/1.83.0-GCC-13.2.0 Ninja/1.12.1-GCCcore-13.3.0 OpenMPI/4.1.6-GCC-13.2.0
    - cmake --preset default
    - cmake --build --preset default
    - ctest --preset default</code></pre>
</div>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_step_3_deploying_through_jacamarci_to_slurm"><a class="anchor" href="#_step_3_deploying_through_jacamarci_to_slurm"></a>2.3. Step 3: Deploying through JacamarCI to SLURM</h3>
<div class="paragraph">
<p>Actually, the above solution is not the solution for running on Karolina.</p>
</div>
<div class="paragraph">
<p>This is because, we should follow the official and secure way of running on Karolina. This means we must utilise the JacamarCI executor, and any CI job we want to run on Karolina must be submitted as an sbatch job through Gitlab Runner and JacamarCI working together.</p>
</div>
<div class="paragraph">
<p>The following .gitlab-ci.yml file gives us what we need.</p>
</div>
<div class="listingblock">
<div class="title">.gitlab-ci.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">stages:
  - build-test

build-and-test:
  stage: build-test

  tags:
    - it4i
    - karolina
    - slurmjob

  rules:
    - if: $CI_COMMIT_BRANCH == 'main'
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

  id_tokens:
    SITE_ID_TOKEN:
      aud: https://code.it4i.cz/

  variables:
    GIT_CHECKOUT: "true"
    SCHEDULER_PARAMETERS: '-A DD-24-88 -p qcpu_exp -N 1 --ntasks-per-node=4'

  script:
    - module load Boost/1.83.0-GCC-13.2.0 Ninja/1.12.1-GCCcore-13.3.0 OpenMPI/4.1.6-GCC-13.2.0
    - cmake --preset default
    - cmake --build --preset default
    - ctest --preset default</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_uploading_the_built_package_as_an_artifact"><a class="anchor" href="#_step_4_uploading_the_built_package_as_an_artifact"></a>2.4. Step 4: Uploading the built package as an artifact</h3>
<div class="paragraph">
<p>Like we did in the Github Actions part, we can also upload built packages as artifacts to Gitlab.
However, the syntax is different. Look at the documentation and try to figure it out.
If short on time, can look at the solution.</p>
</div>
<div class="listingblock">
<div class="title">ci.yml (Github Actions)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- name: Upload tarball
  uses: actions/upload-artifact@v4
  with:
    name: archive-${{ matrix.runs-on }}
    path: |
      build/default/*.tar.gz
      README.adoc</code></pre>
</div>
</div>
<details class="proof">
<summary class="title">Solution</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">build-and-test:
  tags:
    - it4i
    - karolina
    - slurmjob

  id_tokens:
    SITE_ID_TOKEN:
      aud: https://code.it4i.cz/

  rules:
    - if: $CI_COMMIT_BRANCH == 'main'
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

  variables:
    GIT_CHECKOUT: "true"
    SCHEDULER_PARAMETERS: '-A DD-24-88 -p qcpu_exp -N 1 --ntasks-per-node=4'

  script:
    - module load Boost/1.83.0-GCC-13.2.0 Ninja/1.12.1-GCCcore-13.3.0 OpenMPI/4.1.6-GCC-13.2.0
    - cmake --preset default
    - cmake --build --preset default
    - ctest --preset default
    - cmake --build --preset default -t package

  artifacts:
    paths:
      - build/default/*.tar.gz
      - README.adoc
    expire_in: 1 week</code></pre>
</div>
</div>
</div>
</details>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bonus_exercise_self_hosted_runners"><a class="anchor" href="#_bonus_exercise_self_hosted_runners"></a>3. (Bonus) Exercise: Self-hosted Runners</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have now used both kinds of runners available to us through IT4I.
To give you more of a feel of how the runners work, we will work
through this bonus exercise, and set up our own personal runner, on our systems.</p>
</div>
<div class="paragraph">
<p>Please note, this is just for personal testing. It is not meant to do
any production work. A runner that has access to your system CAN BE dangerous.
For example, if you workflow file deletes important files from your system,
they will be gone from your actual system!</p>
</div>
<div class="sect2">
<h3 id="_setting_up_your_personal_runner"><a class="anchor" href="#_setting_up_your_personal_runner"></a>3.1. Setting up your personal runner</h3>
<div class="paragraph">
<p>Use the instructions at</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.gitlab.com/runner/register/" class="bare">docs.gitlab.com/runner/register/</a></p>
</li>
<li>
<p><a href="https://docs.gitlab.com/runner/install/" class="bare">docs.gitlab.com/runner/install/</a></p>
</li>
<li>
<p><a href="https://docs.gitlab.com/runner/install/linux-manually/" class="bare">docs.gitlab.com/runner/install/linux-manually/</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>to set up your runner on your own system.</p>
</div>
</div>
<div class="sect2">
<h3 id="_building_a_simple_pipeline"><a class="anchor" href="#_building_a_simple_pipeline"></a>3.2. Building a simple pipeline</h3>
<div class="paragraph">
<p>Now, we can create a new workflow, something simple and suitable to run at home (i.e. your system).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A multi-stage simple workflow</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>stages:
  - compile
  - test
  - package

compile:
  stage: compile
  script: cat file1.txt file2.txt &gt; compiled.txt
  artifacts:
    paths:
    - compiled.txt

test:
  stage: test
  script: cat compiled.txt | grep -q 'Hello world'

package:
  stage: package
  script: cat compiled.txt | gzip &gt; packaged.gz
  artifacts:
    paths:
    - packaged.gz</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bonus_exercise_containers_through_gitlab"><a class="anchor" href="#_bonus_exercise_containers_through_gitlab"></a>4. (Bonus) Exercise: Containers through GitLab</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now, let us attempt to make use of the containerisation work done on
Day 2, and skip the creation of the docker file and the Apptainer
conversion.  Instead, we will directly pull the apptainer image we
created, and submit it to SLURM via JacamarCI.</p>
</div>
<div class="paragraph">
<p>This will have the advantage that we won&#8217;t need the bash script
infrastructure that we previously needed with the Github Actions
workflow, in order to deploy or apptainer image to SLURM. Instead, we
can do this simply through the Gitlab Runner and JacamarCI combo.</p>
</div>
<div class="sect2">
<h3 id="_deploying_to_slurm"><a class="anchor" href="#_deploying_to_slurm"></a>4.1. Deploying to SLURM</h3>
<div class="listingblock">
<div class="title">deploy.yml (Github Actions)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">name: Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    strategy:
      matrix:
        runs-on: [self-ubuntu-24.04, karolina]
    runs-on: ${{ matrix.runs-on }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create sif filename
        run: |
          sif=$(basename "${{ github.repository }}.sif")
          echo "SIF_FILENAME=$sif" &gt;&gt; $GITHUB_ENV
      - name: Set APPTAINER_CMD
        run: |
          if [ "${{ matrix.runs-on }}" == "karolina" ]; then
            apptainer_cmd=apptainer
          else
            apptainer_cmd=/opt/apptainer/v1.4.0/apptainer/bin/apptainer
          fi
          echo "Using apptainer command: $apptainer_cmd"
          # Save the command in the environment for subsequent steps
          echo "APPTAINER_CMD=$apptainer_cmd" &gt;&gt; $GITHUB_ENV
      - name: PULL Apptainer SIF
        run: |
          # Pull the SIF file from GHCR
          $APPTAINER_CMD pull -F $SIF_FILENAME oras://ghcr.io/${{ github.repository }}:2.0-sif
          # inspect the SIF file
          $APPTAINER_CMD inspect $SIF_FILENAME
      - name: Run Container on self-ubuntu-24.04
        if: matrix.runs-on == 'self-ubuntu-24.04'
        run: |
          # Run the SIF using the stored APPTAINER_CMD command and mpirun
          mpirun -np 4 $APPTAINER_CMD run --sharens $SIF_FILENAME myapp
      - name: Run Container on Karolina
        if: matrix.runs-on == 'karolina'
        run: |
          bash job_monitor.sh $SIF_FILENAME</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">.gitlab-ci.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">stages:
  - deploy

apptainer-deploy:
  stage: deploy

  tags:
    - it4i
    - karolina
    - slurmjob

  id_tokens:
    SITE_ID_TOKEN:
      aud: https://code.it4i.cz/

  variables:
    GIT_CHECKOUT: "true"
    SCHEDULER_PARAMETERS: '-A DD-24-88 -p qcpu_exp -N 1 --ntasks-per-node=4'
    SIF_FILENAME: coe-hidalgo2/202503-c3b-prudhomm.sif

  script:
    - apptainer pull oras://ghcr.io/coe-hidalgo2/202503-c3b-prudhomm:main-sif
    - apptainer inspect 202503-c3b-prudhomm.sif
    - mpirun -np 4 apptainer run --sharens 202503-c3b-prudhomm.sif myapp</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer"
    style="border-top: 2px solid #e9e9e9; background-color: #fafafa; padding-bottom: 2em; padding-top: 2em;">
    <div class="container" style="display: flex; flex-direction: column; align-items: center; gap: 0.5em;">
        <div>
            <a href="https://www.cemosis.fr">
                <img src="../../_/img/cemosis-logo.svg" alt="Cemosis logo" height="50">
            </a>
            &nbsp;&nbsp;&nbsp;&nbsp;
            <a href="https://www.unistra.fr">
                <img src="../../_/img/logo-unistra.png" alt="Unistra logo" height="50">
            </a>
        </div>
        <span style="font-size: 0.8rem; color: #9e9e9e">© 2025 <a href="https://www.cemosis.fr"
                style="text-decoration: underline;">Cemosis</a>, Université de Strasbourg</span>
    </div>
</footer><script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>


<script async src="../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script async src="../../_/js/vendor/fontawesome.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>


<script type="text/javascript">
function toggleFullScreen() {
   var doc = window.document;
   var docEl = doc.documentElement;

   var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
   var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

   if(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
       requestFullScreen.call(docEl);
   }
   else {
       cancelFullScreen.call(doc);
   }
}
</script>
  </body>
</html>
